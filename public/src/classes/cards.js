const CARDS_SVG = Object.freeze({
    Infantry: `
        <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
        <svg viewBox="0 0 512 512">
            <g>
                <path d="M197.62,238.574v-45.828c-14.75,5.27-31.722,11.334-49.026,17.522L197.62,238.574z"/>
                <path d="M122.679,275.084c0.007,9.827,1.453,19.409,4.319,28.605l49.549-28.605l-49.549-28.605
                    C124.132,255.675,122.679,265.264,122.679,275.084z"/>
                <path d="M260.854,275.084l13.474,7.776c1.99-0.713,3.627-1.297,4.856-1.732c5.046-1.807,17.963-7.022,35.192-14.112
                    c-0.577-7.015-1.902-13.881-3.98-20.536L260.854,275.084z"/>
                <path d="M256.066,186.594c-5.25-2.214-10.703-3.96-16.292-5.203v57.183l49.46-28.551
                    C279.937,199.918,268.63,191.904,256.066,186.594z"/>
                <path d="M297.275,158.573c-22.404-15.145-49.535-24.014-78.574-24.007c-19.355-0.007-37.881,3.932-54.704,11.049
                    c-25.236,10.676-46.656,28.469-61.8,50.887c-15.158,22.404-24.021,49.535-24.014,78.581c0,19.348,3.932,37.875,11.056,54.696
                    c10.676,25.236,28.469,46.656,50.88,61.8c22.411,15.158,49.536,24.02,78.582,24.014c19.348,0,37.875-3.932,54.703-11.049
                    c25.236-10.683,46.656-28.476,61.8-50.887c15.151-22.412,24.014-49.535,24.007-78.574c0.007-19.355-3.932-37.882-11.05-54.703
                    C337.486,195.137,319.693,173.718,297.275,158.573z M230.408,170.356c10.302,1.134,20.129,3.728,29.304,7.613
                    c17.521,7.403,32.611,19.498,43.783,34.636l-67.444,38.941c-1.752-1.29-3.626-2.404-5.644-3.287V170.356z M159.787,187.68
                    c13.793-9.304,29.826-15.416,47.199-17.338v77.916c-2.01,0.883-3.892,1.997-5.637,3.287l-67.464-38.955
                    C141.042,202.9,149.79,194.431,159.787,187.68z M113.314,275.084c0-14.601,2.954-28.421,8.279-41.02
                    c0.17-0.408,0.38-0.801,0.556-1.208l67.464,38.954c-0.115,1.073-0.19,2.16-0.19,3.274c0,1.1,0.074,2.186,0.19,3.259l-67.491,38.982
                    C116.458,304.408,113.321,290.147,113.314,275.084z M206.986,379.805c-10.296-1.141-20.13-3.735-29.297-7.614
                    c-17.522-7.409-32.612-19.498-43.79-34.635l67.45-38.934c1.745,1.29,3.626,2.404,5.637,3.28V379.805z M218.7,286.792
                    c-6.472,0-11.715-5.243-11.715-11.708c0-6.472,5.243-11.715,11.715-11.715c6.465,0,11.708,5.243,11.708,11.715
                    C230.408,281.549,225.166,286.792,218.7,286.792z M277.608,362.473c-13.793,9.31-29.82,15.429-47.199,17.344v-77.916
                    c2.017-0.876,3.892-1.99,5.644-3.28l67.457,38.941C296.351,347.261,287.611,355.723,277.608,362.473z M315.808,316.095
                    c-0.17,0.408-0.38,0.795-0.557,1.202L247.78,278.35c0.116-1.08,0.197-2.166,0.197-3.266c0-1.114-0.081-2.2-0.197-3.274
                    l67.498-38.968c5.664,12.916,8.802,27.171,8.808,42.241C324.08,289.685,321.132,303.498,315.808,316.095z"/>
                <path d="M61.959,275.084c-0.007-15.416,2.296-30.316,6.458-44.428l-31.321,11.192
                    c-4.265,1.528-6.492,6.166-5.093,10.431c-19.858,9.874-40.055,37.026-28.741,68.693c11.315,31.654,44.158,39.872,65.767,34.914
                    c1.63,4.197,6.289,6.357,10.554,4.842l6.438-2.302c-4.462-7.09-8.428-14.526-11.728-22.33
                    C66.346,317.332,61.959,296.666,61.959,275.084z"/>
                <path d="M477.772,96.406l-14.506,5.182c-10.16,3.634-6.479,9.854-24.394,16.251c-1.827,0.652-5.494,1.834-10.581,3.423
                    c-2.139-2.825-5.901-4.088-9.412-2.839c-3.26,1.168-5.345,4.164-5.501,7.43c-31.546,9.602-54.351,15.402-95.75,27.742
                    c19.681,16.041,35.436,36.707,45.481,60.47c3.898,9.216,6.933,18.9,9.018,28.923c35.097-14.954,45.393-22.071,71.396-32.781
                    c2.187,2.424,5.705,3.429,8.964,2.255c3.511-1.257,5.616-4.625,5.481-8.157c4.937-1.996,8.523-3.409,10.356-4.06
                    c17.908-6.411,19.008,0.733,29.169-2.894L512,192.169L477.772,96.406z"/>
            </g>
        </svg>
    `,
    Cavalry: `
        <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
        <svg viewBox="0 0 260 260">
            <path d="M258,2l-16,48L97.06,181.76l-7.23-11.14l-11.68-7.58L210,18L258,2z M101.029,238.26l11.314-11.314l-31.176-48.02
                l-48.02-31.176l-11.314,11.314l31.386,31.386l-34.26,37.693c-4.464-0.586-9.138,0.82-12.568,4.249
                c-5.858,5.858-5.858,15.355,0,21.213c5.858,5.858,15.355,5.858,21.213,0c3.428-3.428,4.834-8.1,4.25-12.562l37.695-34.262
                L101.029,238.26z"/>
        </svg>
    `,
    Artillery: `
        <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
        <svg viewBox="0 0 512 512">
            <path d="M323.8 149.6l10.4 13.8L491.8 43.8 481.4 30zm-95.1 72.2l25.3 33.3-68.7 64.7-21.5-10.1 9.3-45.7zM18.3 424.2l99.1-95.3
                s21.7 10.5 27.5 8.7c.5-.2 1-.4 1.4-.8 2.6-2 6-6.9 9.1-12l1.1.5 19 8.8L74.3 482c-6.8-40.3-51.6-57.5-56-57.8zm224.1-212.8l67.7-51.3 17.1 22.6
                c4.7 6.3 3.9 15.5-2.4 20.2l-56.4 42.8-.7-1zm-64.8 182.3c7.9 4.8 18.3 2.3 23.1-5.7l14-23.1
                c3.4-5.7 3.2-12.8-.6-18.3 1.3-.7 2.5-1.5 3.6-2.3 5.4-4 9-9.9 10.1-16.4 1.1-6.8-.5-13.8-4.4-20.3l-6.4 6.1
                c2.1 3.9 3 8.4 2.3 12.9-1 6.4-5.7 11.5-12.7 14.2-7.7-3.1-16.5-.2-20.7 6.9l-14 23.1c-4.8 7.8-2.3 18.1 5.7 22.9zm1.7-18.6l14.1-23.2
                c2.4-3.9 7.4-5.1 11.3-2.8l1.1.8c3.1 2.6 3.8 7.1 1.7 10.5l-14.1 23.2c-2.4 3.9-7.4 5.2-11.3 2.8-3.9-2.3-5.2-7.4-2.8-11.3zm167.6-189
                c-.5-3-1.5-5.9-2.8-8.7L488.5 67.9l5.2 6.9zm-192.7 84.5l-3.2 15.6c-7.7-3.3-10.2-12.1-18.1-9.2 2.4-8.6 16.4-5.3 21.3-6.4z"/>
        </svg>
    `,
});

const Cards = (() => {
    let cards = [];
    let selectedCards = [];
    let errorTimeout;

    const countCardSet = (cards) => {
        const count = {
            Infantry: 0,
            Cavalry: 0,
            Artillery: 0,
        };
        cards.forEach((cardType) => count[cardType]++);
        let cardSet = undefined;
        if (count.Infantry >= 1 && count.Cavalry >= 1 && count.Artillery >= 1)
            cardSet = 'All';
        else if (count.Infantry >= 3) cardSet = 'Infantry';
        else if (count.Cavalry >= 3) cardSet = 'Cavalry';
        else if (count.Artillery >= 3) cardSet = 'Artillery';
        return cardSet;
    };

    const initialize = () => {
        $('#trade-cards-button').on('click', () => {
            if (GameStateMachine.state !== 'SelfDraft') {
                showError(
                    'You cannot trade-in cards outside of your draft phase.'
                );
                return;
            }

            const cardSet = countCardSet(
                selectedCards.map((cardId) => cards[cardId])
            );

            if (!cardSet) {
                showError('This is not a valid card set.');
                return;
            }

            selectedCards = [];
            hideError();
            Socket.requestCardTrade(cardSet);
        });

        $('#close-cards-overlay-button').on('click', () => {
            hideError();
            hide();
        });

        $('#open-cards-button').on('click', () => {
            show();
        });

        hide();
    };

    const updateCards = (cards_) => {
        if (cards_.length === cards.length + 1) {
            let newCards = cards_.map((card) => card);
            cards.forEach((oldCard) => {
                const i = newCards.findIndex((c) => c === oldCard);
                newCards = newCards.filter((_, idx) => idx !== i);
            });
            Notification.queueNotification('card', { card: newCards[0] });
        }

        // update local cards state
        cards = cards_;

        // populate card container with card elements
        $('#cards-container').empty();
        cards
            .map((card, idx) =>
                $(`
                <div id="card-${idx}" class="card">
                    ${CARDS_SVG[card]}
                    ${card}
                </div>
            `)
            )
            .forEach((el) => {
                $('#cards-container').append(el);
            });

        // set up card elements' onClick
        $('.card').on('click', (e) => {
            const cardElement = $(e.currentTarget);
            const cardId = cardElement.attr('id').split('-')[1];
            if (selectedCards.includes(cardId)) {
                selectedCards = selectedCards.filter((cId) => cId !== cardId);
                cardElement.removeClass('selected');
            } else {
                if (selectedCards.length >= 3) return;
                selectedCards.push(cardId);
                cardElement.addClass('selected');
            }

            // (en)/(dis)able trade button
            if (selectedCards.length >= 3) {
                $('#trade-cards-button').prop({ disabled: false });
            } else {
                $('#trade-cards-button').prop({ disabled: true });
            }
        });

        // update number on open button
        $('#cards-count-text').text(cards.length);

        // display alert if have tradeable set
        if (countCardSet(cards)) {
            $('#open-cards-button-alert').show();
        } else {
            $('#open-cards-button-alert').hide();
        }

        // default disable trade button
        $('#trade-cards-button').prop({ disabled: true });
    };

    const hide = () => {
        $('#cards-overlay').fadeOut();
    };

    const show = () => {
        $('#cards-overlay').fadeIn();
        if (GameStateMachine.state === 'SelfDraftSelected')
            GameStateMachine.transition('back');
    };

    const showError = (message) => {
        $('#cards-error').removeClass('hidden');
        $('#cards-error').text(message);

        if (errorTimeout) clearTimeout(errorTimeout);
        errorTimeout = setTimeout(() => {
            hideError();
        }, 5000);
    };

    const hideError = () => {
        $('#cards-error').addClass('hidden');
        $('#cards-error').text('error');
    };

    const reset = () => {
        cards = [];
        selectedCards = [];
        if (errorTimeout) clearTimeout(errorTimeout);
        errorTimeout = undefined;
        updateCards([]);
    };

    return {
        initialize,
        updateCards,
        reset,
    };
})();
